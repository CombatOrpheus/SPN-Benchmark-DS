"""This module provides a reader class for SPN HDF5 datasets."""

import h5py
from pathlib import Path
from typing import Dict, Any, Iterator, Optional, List


class SPNDataReader:
    """A reader for SPN HDF5 datasets.

    This class provides an interface to read data from HDF5 files generated by
    SPNGenerate.py. It supports retrieving the total number of samples,
    accessing a specific sample by index, and iterating over all samples.

    Args:
        hdf5_path: The path to the HDF5 file.
    """

    def __init__(self, hdf5_path: Path) -> None:
        """Initializes the SPNDataReader.

        Args:
            hdf5_path: The path to the HDF5 file.
        """
        self.hdf5_path = hdf5_path
        self._file: Optional[h5py.File] = None
        self._sample_keys: Optional[List[str]] = None

    def __enter__(self) -> "SPNDataReader":
        """Opens the HDF5 file and prepares for reading."""
        self._file = h5py.File(self.hdf5_path, "r")
        if "dataset_samples" not in self._file:
            raise ValueError("HDF5 file does not contain 'dataset_samples' group.")
        self._sample_keys = sorted(self._file["dataset_samples"].keys())
        return self

    def __exit__(self, exc_type, exc_val, exc_tb) -> None:
        """Closes the HDF5 file."""
        if self._file:
            self._file.close()
            self._file = None
            self._sample_keys = None

    def __len__(self) -> int:
        """Returns the total number of samples in the dataset."""
        if self._sample_keys is not None:
            return len(self._sample_keys)
        with h5py.File(self.hdf5_path, "r") as hf:
            if "dataset_samples" in hf:
                return len(hf["dataset_samples"])
            return 0

    def get_sample(self, index: int) -> Dict[str, Any]:
        """Retrieves a single sample by its index.

        Args:
            index: The index of the sample to retrieve.

        Returns:
            A dictionary containing the data for the specified sample.
        """
        if not 0 <= index < len(self):
            raise IndexError("Index out of range.")

        if self._file is not None and self._sample_keys is not None:
            sample_name = self._sample_keys[index]
            sample_group = self._file["dataset_samples"][sample_name]
            return {key: value[()] for key, value in sample_group.items()}

        with h5py.File(self.hdf5_path, "r") as hf:
            sample_name = sorted(hf["dataset_samples"].keys())[index]
            sample_group = hf["dataset_samples"][sample_name]
            return {key: value[()] for key, value in sample_group.items()}

    def __iter__(self) -> Iterator[Dict[str, Any]]:
        """Returns an iterator that yields one sample at a time."""
        for i in range(len(self)):
            yield self.get_sample(i)
